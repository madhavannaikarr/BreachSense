<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dark Web Intel — Advanced Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    /* * --- GLOBAL STYLES --- */
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#6ee7b7; --danger:#ff6b6b; --glass: rgba(255,255,255,0.04);
      --glass-2: rgba(255,255,255,0.02);
    }
    html,body{
        height:100%;
        margin:0;
        font-family:'Times New Roman', serif; 
        background:linear-gradient(180deg,#071021 0%, #0f1724 100%);
        color:#e6eef6;
        font-size: 16px;
    }
    .wrap{max-width:1400px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:24px;margin-bottom:24px}
    .logo{
        width:72px;height:72px;border-radius:14px;
        background:linear-gradient(135deg,#00b0ff,#003cff);
        display:flex;align-items:center;justify-content:center;
        font-weight:800;
        font-size: 32px;
        color:#fff;
        box-shadow:0 8px 30px rgba(0, 50, 200, 0.7);
        border: 2px solid #fff;
    }
    h1{font-size:36px;margin:0;font-weight:700}
    p.lead{margin:0;color:var(--muted);font-size:18px}

    /* cards row */
    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-top:20px;margin-bottom:30px}
    .card{background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.02));padding:20px;border-radius:16px;box-shadow:0 8px 25px rgba(2,6,23,0.8);border:1px solid var(--glass)}
    .card .label{font-size:16px;color:var(--muted);font-weight: bold;}
    .card .value{font-size:48px;font-weight:800;margin-top:10px}

    /* layout main */
    .grid{display:grid;grid-template-columns: 1fr 480px;gap:24px}
    .panel{background:var(--card);padding:20px;border-radius:16px;border:1px solid var(--glass)}
    .panel h3{margin:0 0 15px 0;font-size:24px}
    .searchbar{display:flex;gap:12px;align-items:center;margin-bottom:15px}
    input.search, select.sort{
        flex:1;padding:12px 16px;border-radius:10px;
        border:1px solid var(--glass-2);
        background:transparent;color:inherit;
        font-size: 16px;
    }

    /* table */
    table{width:100%;border-collapse:collapse;color:#e6eef6;font-size: 16px;}
    thead th{font-size:14px;text-align:left;padding:15px 10px;background:linear-gradient(180deg, rgba(255,255,255,0.04), transparent);border-bottom:2px solid rgba(255,255,255,0.08)}
    tbody td{padding:15px 10px;border-bottom:1px dashed rgba(255,255,255,0.03);vertical-align:middle}
    .email{font-weight:700;color:#cfeffd;font-size: 18px;}
    .muted{color:var(--muted);font-size:15px}

    /* micro percentage bar */
    .microbar{height:10px;background:linear-gradient(90deg,#1f2937,#0b1220);border-radius:8px;overflow:hidden}
    .microbar > i{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#2dd4bf);width:0%;transition:width 700ms cubic-bezier(.2,.9,.2,1)}

    /* * --- RICH TOOLTIP/CARD STYLES --- */
    .tooltip{
      position:fixed;pointer-events:none;z-index:9999;
      padding:16px;border-radius:14px;
      background:rgba(3,7,18,0.95);
      color:#dff7ff;
      box-shadow:0 15px 40px rgba(0,0,0,0.8);
      max-width:380px;
      font-size:16px;
      border:2px solid var(--accent);
      transform-origin:left top;
      opacity:0;
      transform: scale(0.9);
      transition:transform .12s ease,opacity .12s ease;
    }
    .tooltip-header{
        font-size: 20px; 
        font-weight:800; 
        margin-bottom: 8px; 
        color: var(--accent);
    }
    .tooltip-breach-list{
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed rgba(255,255,255,0.1);
    }
    .tooltip-breach-item{
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 15px;
    }
    .tooltip-breach-item span{
        margin-right: 12px;
        font-size: 22px; /* Bigger Icon Size */
        line-height: 1;
    }
    .tooltip-breach-item div{
        flex: 1;
        font-weight: 700;
        color: #fff;
    }
    .tooltip-breach-item small{
        color: var(--muted);
        font-size: 13px;
        margin-left: 10px;
    }

    /* congratulations Popper (Static part) */
    .congrats{
      position:fixed;left:50%;top:12%;
      transform:translateX(-50%) scale(0.9);
      background:linear-gradient(90deg,#06b6d4,#60a5fa);
      color:#022;padding:24px 32px;
      border-radius:16px;
      box-shadow:0 30px 80px rgba(8,12,24,0.8);
      display:flex;align-items:center;gap:16px;
      z-index:9998;opacity:0;pointer-events:none;
      transition:opacity .3s ease,transform .3s ease;
    }
    .congrats.show{opacity:1;pointer-events:auto;transform:translateX(-50%) scale(1)}
    .congrats .tick{
        background:#022;padding:12px;border-radius:12px;
        color:var(--accent);font-weight:800;font-size: 24px;
    }
    .congrats > div > div{ font-size: 18px; }

    /* Confetti Canvas - Must be full screen and behind the Popper */
    #confetti-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9997; /* Below the popper (9998) */
    }

    /* responsive */
    @media (max-width:1200px){
        .grid{grid-template-columns:1fr; }
        .cards{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:768px){
        .logo{width:56px;height:56px;font-size:24px;}
        h1{font-size:28px;}
        .card .value{font-size:36px;}
        .cards{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  
  <canvas id="confetti-canvas"></canvas>

  <div class="wrap">
    <header>
      <div class="logo">
        &#128165; 
      </div>
      <div>
        <h1>BreachSense </h1>
        <p class="lead">Click on an email to see full details.</p>
      </div>
    </header>

    <div class="cards" id="cards">
      <div class="card">
        <div class="label">Total Checked Accounts</div>
        <div class="value" id="card-checked">—</div>
      </div>
      <div class="card">
        <div class="label">Accounts With Breaches</div>
        <div class="value" id="card-leaked">—</div>
      </div>
      <div class="card">
        <div class="label">Safe Percentage</div>
        <div class="value" id="card-safe">—</div>
      </div>
      <div class="card">
        <div class="label">Most Common Source</div>
        <div class="value" id="card-topsource">—</div>
      </div>
    </div>

    <div class="grid">
      <div>
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center; flex-wrap: wrap;">
            <h3>Detected Email Breaches</h3>
            <div style="display:flex;gap:12px;align-items:center">
              <input class="search" id="search" placeholder="Search email or source..." />
              <select class="sort" id="sort">
                <option value="leaks_desc">Sort: Leaks (high→low)</option>
                <option value="leaks_asc">Sort: Leaks (low→high)</option>
                <option value="alpha">Sort: Email (A→Z)</option>
              </select>
            </div>
          </div>

          <table id="emailsTable">
            <thead>
              <tr>
                <th>Account & Name</th>
                <th>Total Leaks</th>
                <th>Top Sources</th>
                <th>Risk Score</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="right">
        <div class="panel" style="margin-bottom:16px">
          <h3>Summary Charts</h3>
          <div class="right-charts" style="display:flex;gap:16px;flex-direction:column">
            <div class="chart-box" style="height:300px;"><canvas id="barChart" style="max-width:100%"></canvas></div>
            <div style="display:flex;gap:16px;align-items:center; flex-wrap: wrap;">
              <div style="flex:1; min-width: 150px;">
                <div class="chart-box" style="height:200px;"><canvas id="donutChart"></canvas></div>
              </div>
              <div style="width:180px">
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">Top 5 Sources</div>
                <div class="muted">Emails per source:</div>
                <div style="margin-top:12px" id="top-sources-list"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h3>Details</h3>
          <div class="muted" id="explain">Hover over any email row to see full breach sources, names, and location details.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="tooltip" class="tooltip"></div>
  
  <div id="congrats" class="congrats">
    <div class="tick">✔</div>
    <div>
      <div style="font-weight:800; font-size: 20px;">CONGRATULATIONS!</div>
      <div class="muted" style="color:#022;">You have 0 breaches!!!</div>
    </div>
  </div>
<script>
  // --- Configuration Mappings for Rich Data ---
  // 1. Simple Name -> Full Name (Guesses based on email format)
  function guessName(email) {
    if (!email) return "Name Not Found";
    // Tries to convert 'first.last@domain.com' to 'First Last'
    const userPart = email.split('@')[0];
    const parts = userPart.split(/[._-]/); // Split by common separators
    const name = parts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
    // Fallback if the name is still unformatted (e.g., 'drkalbande' -> 'Drkalbande')
    return name || "N/A";
  }

  // 2. Breach Source Name -> Rich Data (Location, Icon/Logo)
  // Icons use Unicode/Emoji as a replacement for image files
  const SOURCE_MAPPING = {
    // Common Examples
    "TrueCaller India": { location: "India", icon: "🇮🇳" },
    "LuminPDF.com": { location: "Worldwide", icon: "📄" },
    "Twitter.com (scraping data)": { location: "USA (Social)", icon: "🐦" },
    "Chegg.com": { location: "Education", icon: "📚" },
    "Bigbasket.com": { location: "India (E-commerce)", icon: "🛒" },
    "Facebook": { location: "Social Media", icon: "👤" },
    "LinkedIn": { location: "Professional", icon: "💼" },
    "Canva": { location: "Design Tool", icon: "🖼️" },
    "Adobe": { location: "Software", icon: "🎨" },
    "Gethub": { location: "Code Repository", icon: "💻" },
    // Default fallback
    "Default": { location: "Unknown Global Location", icon: "❓" }
  };

  // Helper: fetch JSON file (same folder)
  async function loadResults() {
    try {
      // NOTE: This path is hardcoded from the original HTML
      const res = await fetch("out/leak_results.json");
      if (!res.ok) throw new Error("File not found: out/leak_results.json");
      const data = await res.json();
      return data;
    } catch (e) {
      console.error(e);
      alert("Could not load out/leak_results.json. Ensure it's in the 'out' folder and contains valid JSON data with unmasked emails.");
      throw e;
    }
  }

  // Animate microbars
  function setBar(el, pct){
    const inner = el.querySelector("i");
    requestAnimationFrame(()=> inner.style.width = pct + "%");
  }

  // --- Confetti Logic ---
  const confettiCanvas = document.getElementById('confetti-canvas');
  const myConfetti = confetti.create(confettiCanvas, { resize: true, useWorker: true });

  function fireConfetti() {
    // Fire a barrage of confetti from the center top
    myConfetti({
      particleCount: 200,
      spread: 120,
      origin: { x: 0.5, y: 0.1 },
      colors: ['#00b0ff', '#6ee7b7', '#fff', '#ff6b6b'] // Custom colors
    });

    // Fire another smaller, tighter burst
    myConfetti({
      particleCount: 50,
      spread: 60,
      origin: { x: 0.5, y: 0.1 },
      scalar: 0.8,
      shapes: ['star'],
      colors: ['#003cff', '#06b6d4']
    });
  }

  // Helper for individual congratulations pop-up
  const congratsPopper = document.getElementById("congrats");
  function showIndividualCongrats() {
    congratsPopper.classList.add("show");
    fireConfetti();
    setTimeout(() => congratsPopper.classList.remove("show"), 5000); // Shorter timeout for individual congrats
  }


  // --- Tooltip management: FIXED CARD POSITIONING ON CLICK ---
  const tooltip = document.getElementById("tooltip");
  let lastClickedRow = null; // Track the last row clicked

  function showRichTooltip(r, event) {
    
    // Find the closest table row (<tr>)
    const row = event.target.closest("tr");
    if (!row) return; 

    // If the same row is clicked again, toggle the tooltip off
    if (row === lastClickedRow && tooltip.style.opacity === "1") {
      hideTooltip();
      lastClickedRow = null;
      return;
    }
    
    lastClickedRow = row;
    const emailCell = row.querySelector('td:first-child');
    if (!emailCell) return;
    const cellRect = emailCell.getBoundingClientRect();
    
    // 1. Map simple source names to rich objects
    const richSources = r.sources.map(sourceName => {
        const mapping = SOURCE_MAPPING[sourceName] || SOURCE_MAPPING.Default;
        return { 
            name: sourceName, 
            location: mapping.location, 
            icon: mapping.icon 
        };
    });

    let sourcesHtml = '';
    if (r.found > 0 && richSources.length > 0) {
        sourcesHtml = `<div class="tooltip-breach-list">
            <div style="font-weight:700; margin-bottom: 8px; color: var(--danger);">Breach Locations (${r.found} Total):</div>
            ${richSources.map(s => `
                <div class="tooltip-breach-item">
                    <span>${s.icon}</span>
                    <div>${s.name}</div>
                    <small>${s.location}</small>
                </div>
            `).join('')}
        </div>`;
    } else {
        sourcesHtml = '<div style="color:var(--accent); font-weight:700; margin-top: 10px;">✅ No breaches found in our database.</div>';
        // Trigger confetti/congrats for individual 0-breach email on hover
        showIndividualCongrats();
    }

    const html = `
        <div class="tooltip-header">${r.email}</div>
        <div class="muted" style="margin-bottom: 10px;">${r.name}</div>
        ${sourcesHtml}
    `;

    tooltip.innerHTML = html;
    
    // Position the tooltip logic using requestAnimationFrame for better performance before size check
    requestAnimationFrame(() => {
        // Set initial horizontal position anchored to the left of the email cell
        tooltip.style.left = (cellRect.left + window.scrollX) + "px";
        
        // Temporarily show it to calculate its size accurately
        tooltip.style.opacity = 1;
        tooltip.style.transform = "scale(1)";

        const tooltipRect = tooltip.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // Vertical Positioning Fix (Scroll visibility)
        
        // Calculate position if placed BELOW the row (10px offset)
        let desiredTop = cellRect.bottom + 10 + window.scrollY;
        
        // Calculate how far the bottom of the tooltip would be from the top of the viewport
        let tooltipBottomInView = (cellRect.bottom + 10 + tooltipRect.height);

        // Check if the tooltip goes past the bottom edge of the viewport
        if (tooltipBottomInView > viewportHeight) {
            // Option 1: Flip UPWARDS (anchor to the top of the row, minus height and offset)
            let topFlipped = cellRect.top - tooltipRect.height - 10 + window.scrollY;
            
            // If flipping up is still below the top of the viewport (i.e., not off the top), use it
            if (topFlipped > window.scrollY) {
                desiredTop = topFlipped;
            } else {
                // Option 2: If both above and below are problematic, just put it at the bottom of the view
                desiredTop = (viewportHeight - tooltipRect.height - 10) + window.scrollY;
                if (desiredTop < 0) desiredTop = 10; // safety minimum
            }
        }

        tooltip.style.top = desiredTop + "px";

        // Horizontal Positioning Fix (Right side)
        if (tooltipRect.right > viewportWidth) {
            // If it goes off screen, shift it left by the amount it overflowed, plus a small margin
            const overflow = tooltipRect.right - viewportWidth;
            let newLeft = (cellRect.left + window.scrollX) - overflow - 10;
            
            // Ensure it doesn't shift off the left side
            if (newLeft < 0) newLeft = 10; 
            
            tooltip.style.left = newLeft + 'px';
        }
    });
  }
  
  function hideTooltip(){ 
    tooltip.style.opacity = 0; 
    tooltip.style.transform = "scale(.9)"; // Consistent hide scale
  }

  // Close tooltip when clicking outside the table or tooltip itself
  document.addEventListener("click", (e) => {
    if (e.target.closest("#emailsTable") === null && e.target.closest("#tooltip") === null) {
      hideTooltip();
      lastClickedRow = null;
    }
  });


  // Render table and charts
  (async function(){
    let raw;
    try {
        raw = await loadResults();
    } catch {
        return; // Stop execution if data load fails
    }

    // Process results: add the name field
    const results = raw.map(r => ({
        email: r.email,
        name: guessName(r.email), // Add guessed name
        found: Number(r.found || 0),
        sources: r.sources || []
    }));

    // --- Summary Calculations ---
    const total = results.length;
    const leakedCount = results.filter(r=>r.found>0).length;
    const safePct = total > 0 ? Math.round(((total - leakedCount) / total) * 100) : 0;
    
    const topSourceCounts = {};
    results.forEach(r => r.sources.forEach(sourceName=>{
      topSourceCounts[sourceName] = (topSourceCounts[sourceName]||0) + 1;
    }));
    const topSources = Object.entries(topSourceCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);

    // --- Update Cards ---
    document.getElementById("card-checked").textContent = total;
    document.getElementById("card-leaked").textContent = leakedCount;
    document.getElementById("card-safe").textContent = safePct + "%";
    document.getElementById("card-topsource").textContent = topSources[0] ? topSources[0][0] : "None";

    // --- Conditional Popper & Confetti (Global 0 Leaks) ---
    if (leakedCount === 0 && total > 0) {
      // Note: congratsPopper is defined globally above
      congratsPopper.classList.add("show");
      fireConfetti(); // FIRE CONFETTI
      setTimeout(()=> congratsPopper.classList.remove("show"), 8000); 
    }

    // --- Table Rendering Logic (Initial/Rerender) ---
    const tbody = document.querySelector("#emailsTable tbody");
    const maxFound = Math.max(1, ...results.map(r=>r.found));
    
    // Function to render/rerender the table rows
    const renderTableRows = (data) => {
        tbody.innerHTML = "";
        data.forEach((r, idx) => {
            const tr = document.createElement("tr");
            // Assign the result object to the row element for easy access in handlers
            tr.dataset.resultIndex = results.indexOf(r);

            // ... (rest of the row creation is the same)
            const tdEmail = document.createElement("td");
            tdEmail.innerHTML = `<div class="email">${r.email}</div><div class="muted">${r.name}</div>`;
            
            const tdFound = document.createElement("td");
            tdFound.innerHTML = `<div style="font-weight:800; font-size: 18px;">${r.found}</div>`;
            
            const tdSources = document.createElement("td");
            tdSources.textContent = r.sources.length ? r.sources[0] : "-";
            
            const pct = Math.round((r.found / maxFound) * 100);
            const tdScore = document.createElement("td");
            tdScore.innerHTML = `<div class="microbar"><i style="width:0%"></i></div>`;

            tr.appendChild(tdEmail);
            tr.appendChild(tdFound);
            tr.appendChild(tdSources);
            tr.appendChild(tdScore);
            tbody.appendChild(tr);

            // Animate bar
            setTimeout(()=> setBar(tdScore, pct), 100 + idx*30);

            // *** Use CLICK event for stable card display ***
            tr.addEventListener("click", (ev)=>{
              showRichTooltip(r, ev);
            });
            
        });
    };

    // Sort initially by leaks (desc)
    results.sort((a,b)=> b.found - a.found);
    renderTableRows(results);


    // --- Charting Logic --- (Kept original logic)
    const barCtx = document.getElementById("barChart").getContext("2d");
    const top10Results = results.slice(0, 10);
    const barLabels = top10Results.map(r=> r.email.split('@')[0]); 
    const barData = top10Results.map(r=> r.found);
    const barColors = top10Results.map(r=> r.found>0 ? "#60a5fa" : "#1f2937");
    new Chart(barCtx, {
      type: "bar",
      data: { labels: barLabels, datasets: [{ label: "Leaks per email (Top 10)", data: barData, backgroundColor: barColors }] },
      options:{ responsive:true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{x:{ticks:{color: '#e6eef6', maxRotation: 45, minRotation: 45}}, y:{beginAtZero:true, ticks:{color: '#e6eef6'}}}, layout: { padding: { top: 10 } }}
    });

    const donutCtx = document.getElementById("donutChart").getContext("2d");
    new Chart(donutCtx, {
      type: "doughnut",
      data: {
        labels: ["Accounts Leaked", "Accounts Safe"],
        datasets: [{ data: [leakedCount, total - leakedCount], backgroundColor:["#60a5fa","#2dd4bf"] }]
      },
      options:{
          maintainAspectRatio: false,
          plugins:{
              legend:{position:"bottom", labels: {color: '#e6eef6'}},
              tooltip:{callbacks: { label: (c) => `${c.label}: ${c.formattedValue} (${((c.raw / total) * 100).toFixed(1)}%)` }}
          }
      }
    });

    // top sources list
    const topList = document.getElementById("top-sources-list");
    if (topSources.length===0) topList.innerHTML = '<div class="muted">No sources detected</div>';
    else topList.innerHTML = topSources.map(s=>
      `<div style="font-weight:700; font-size: 16px;">${s[0]}</div>
       <div class="muted" style="margin-bottom: 8px;">${s[1]} occurrences</div>`
    ).join("<hr style='border:none;border-top:1px dashed rgba(255,255,255,0.08);margin:12px 0'>");


    // --- Search & Sort Behavior ---
    const filterAndSort = () => {
        hideTooltip(); // Hide tooltip on filter/sort change
        const q = document.getElementById("search").value.toLowerCase();
        const val = document.getElementById("sort").value;
        let filtered = results.filter(r => {
            const sourceNames = r.sources.join(' ').toLowerCase();
            const rowText = `${r.email} ${r.name} ${sourceNames}`;
            return rowText.includes(q);
        });

        if (val === "leaks_desc") filtered.sort((a,b)=>b.found - a.found);
        else if (val === "leaks_asc") filtered.sort((a,b)=>a.found - b.found);
        else if (val === "alpha") filtered.sort((a,b)=> a.email.localeCompare(b.email));

        renderTableRows(filtered);
    };

    document.getElementById("search").addEventListener("input", filterAndSort);
    document.getElementById("sort").addEventListener("change", filterAndSort);

  })(); 
  </script>
</body>
</html>